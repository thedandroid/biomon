---
phase: 06-test-migration-validation
plan: 03
type: execute
wave: 2
depends_on: ["06-01", "06-02"]
files_modified:
  - test/integration.external.test.ts
  - vitest.config.ts
  - tsconfig.json
autonomous: true

must_haves:
  truths:
    - "integration.external.test.ts compiles without TypeScript errors"
    - "All 12 external integration tests pass"
    - "All 79 tests pass across all test files"
    - "vitest.config.ts includes .test.ts pattern"
    - "tsconfig.json includes test/ directory"
    - "npm run build succeeds"
    - "No any types in any test file"
  artifacts:
    - path: "test/integration.external.test.ts"
      provides: "Typed external namespace tests"
      min_lines: 600
      contains: "TypedExternalClient"
    - path: "vitest.config.ts"
      provides: "TypeScript test configuration"
      contains: "test/**/*.test.ts"
    - path: "tsconfig.json"
      provides: "TypeScript config with test inclusion"
      contains: "test/**/*"
  key_links:
    - from: "test/integration.external.test.ts"
      to: "src/types/events.ts"
      via: "type imports for external namespace events"
      pattern: "ExternalServerToClientEvents"
    - from: "vitest.config.ts"
      to: "test/**/*.test.ts"
      via: "include pattern"
      pattern: "include.*test\\.ts"
---

<objective>
Complete test migration with external tests, config updates, and final validation

Purpose: Migrate the external integration test file, update vitest and tsconfig to support TypeScript tests, and validate the complete migration including pkg build verification.

Output: All test files migrated to TypeScript, configuration updated, and full build validation passing.
</objective>

<execution_context>
@/Users/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-test-migration-validation/06-RESEARCH.md

@src/types/events.ts
@test/integration.external.test.js
@vitest.config.js
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate integration.external.test.js to TypeScript</name>
  <files>test/integration.external.test.ts</files>
  <action>
1. Rename test/integration.external.test.js to test/integration.external.test.ts

2. Add type imports at top of file:
```typescript
import { describe, it, expect, beforeAll, afterAll, beforeEach } from "vitest";
import { io as Client, type Socket as ClientSocket } from "socket.io-client";
import type { Server as HttpServer } from "http";
import type { Server as SocketServer } from "socket.io";
import type {
  GameState,
  Player,
  Effect,
  ServerToClientEvents,
  ClientToServerEvents,
  ExternalServerToClientEvents,
  ExternalClientToServerEvents,
} from "../src/types/index.js";
import { createServer } from "../createServer.ts";
```

3. Define typed client aliases:
```typescript
// Main namespace client
type TypedMainClient = ClientSocket<ServerToClientEvents, ClientToServerEvents>;

// External namespace client (read-only - receives state, sends nothing)
type TypedExternalClient = ClientSocket<ExternalServerToClientEvents, ExternalClientToServerEvents>;
```

4. Type the test variables:
```typescript
describe("External Integration via Socket.io", () => {
  let server: HttpServer;
  let io: SocketServer;
  let port: number;
  let serverUrl: string;
  let externalClient: TypedExternalClient;
  const activeClients: Array<TypedMainClient | TypedExternalClient> = [];
```

5. Type the trackClient helper:
```typescript
const trackClient = <T extends TypedMainClient | TypedExternalClient>(client: T): T => {
  activeClients.push(client);
  return client;
};
```

6. Type the state object:
```typescript
const state: GameState = {
  players: [],
  rollEvents: [],
  missionLog: [],
  metadata: {
    campaignName: null,
    createdAt: null,
    lastSaved: null,
    sessionCount: 0,
  },
};
```

7. Type the server address:
```typescript
const address = server.address();
port = typeof address === 'object' && address !== null ? address.port : 0;
```

8. Type all Promise<GameState> callbacks:
```typescript
await new Promise<void>((resolve) => {
  externalClient.on("state", (receivedState: GameState) => {
    // ...
  });
});
```

9. Type the createServer return value handling:
```typescript
const serverInstance = createServer({
  corsOrigin: "http://localhost:3051",
});
server = serverInstance.server;
io = serverInstance.io;
```

10. Type the newPlayer objects in test handlers:
```typescript
const newPlayer: Player = {
  id: `${Date.now()}-test`,
  name: payload?.name || "Test Player",
  health: payload?.health ?? 5,
  maxHealth: payload?.maxHealth ?? 5,
  stress: payload?.stress ?? 0,
  resolve: payload?.resolve ?? 0,
  activeEffects: [],
  lastRollEvent: null,
};
```

11. Type the effect fixtures:
```typescript
const effect: Effect = {
  id: "effect-123",
  type: "panic_hesitant",
  label: "Hesitant",
  severity: 3,
  createdAt: Date.now(),
  durationType: "manual",
  clearedAt: null,
};
```

12. Delete the original .js file after migration.

IMPORTANT: Do NOT change any test logic or assertions. Only add types.
  </action>
  <verify>npm run typecheck && npm test -- test/integration.external.test.ts</verify>
  <done>integration.external.test.ts compiles with strict mode, all 12 tests pass, no any types</done>
</task>

<task type="auto">
  <name>Task 2: Update configuration files for TypeScript tests</name>
  <files>vitest.config.ts, tsconfig.json</files>
  <action>
1. Rename vitest.config.js to vitest.config.ts

2. Update vitest.config.ts content:
```typescript
// BIOMON - Vitest configuration
import { defineConfig } from "vitest/config";

export default defineConfig({
  test: {
    globals: true,
    environment: "node",
    coverage: {
      provider: "v8",
      reporter: ["text", "json", "html"],
      exclude: [
        "node_modules/**",
        "public/**",
        "scripts/**",
        "*.config.{js,ts}",
      ],
    },
    include: ["test/**/*.test.ts"],
  },
});
```

3. Update tsconfig.json to include test directory:
```json
{
  "compilerOptions": {
    "strict": true,
    "noEmit": true,
    "module": "ESNext",
    "moduleResolution": "Bundler",
    "target": "ES2022",
    "lib": ["ES2022"],
    "esModuleInterop": true,
    "isolatedModules": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "allowJs": true,
    "checkJs": false,
    "declaration": true,
    "declarationDir": "./dist/types"
  },
  "include": ["src/**/*", "test/**/*", "*.js", "*.ts"],
  "exclude": ["node_modules", "dist", "coverage", "public"]
}
```

4. Delete the old vitest.config.js file.
  </action>
  <verify>npm run typecheck passes with test files included</verify>
  <done>vitest.config.ts created with .test.ts pattern, tsconfig.json includes test/ directory</done>
</task>

<task type="auto">
  <name>Task 3: Final validation - all tests and build</name>
  <files>None (validation only)</files>
  <action>
1. Run full type check:
```bash
npm run typecheck
```

2. Run all tests and verify counts:
```bash
npm test
```
Expected: 79 tests pass (17 + 24 + 5 + 21 + 12)

3. Run the build process:
```bash
npm run build
```

4. Verify the build output exists and is executable:
```bash
ls -la dist/biomon* 2>/dev/null || ls -la dist/*.js
```

5. If any validation fails:
   - Fix type errors in test files
   - Ensure all imports use correct paths (.ts or extensionless)
   - Re-run validation

6. Document final test count and any notes.
  </action>
  <verify>
npm run typecheck && npm test && npm run build
All commands must exit 0
  </verify>
  <done>All 79 tests pass, typecheck passes, build succeeds, migration complete</done>
</task>

</tasks>

<verification>
Run comprehensive validation:

```bash
# Full type check (includes test files now)
npm run typecheck

# Run all tests
npm test

# Verify exact test count
npm test 2>&1 | grep -E "Tests.*passed"

# Verify build works
npm run build

# Verify no .test.js files remain
ls test/*.test.js 2>/dev/null && echo "ERROR: .js test files still exist" || echo "OK: All test files migrated to .ts"
```
</verification>

<success_criteria>
- integration.external.test.ts converted to TypeScript
- Original .js test file deleted
- vitest.config.ts created with .test.ts include pattern
- vitest.config.js deleted
- tsconfig.json updated to include test/**/*
- npm run typecheck passes with all test files
- All 79 tests pass (17 + 24 + 5 + 21 + 12)
- npm run build succeeds
- No any types in any test file
- No .test.js files remaining in test/
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-migration-validation/06-03-SUMMARY.md`
</output>
