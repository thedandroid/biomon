---
phase: 06-test-migration-validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - test/utils.test.ts
  - test/responseTables.test.ts
  - test/selfcheck.test.ts
autonomous: true

must_haves:
  truths:
    - "utils.test.ts compiles without TypeScript errors"
    - "responseTables.test.ts compiles without TypeScript errors"
    - "selfcheck.test.ts compiles without TypeScript errors"
    - "All 46 unit tests pass (17 + 24 + 5)"
    - "No any types in migrated test files"
  artifacts:
    - path: "test/utils.test.ts"
      provides: "Typed utility function tests"
      contains: "import type"
    - path: "test/responseTables.test.ts"
      provides: "Typed response table tests"
      contains: "import type"
    - path: "test/selfcheck.test.ts"
      provides: "Typed self-check tests"
      contains: "import type"
  key_links:
    - from: "test/utils.test.ts"
      to: "src/types/state.ts"
      via: "type imports for Player, Effect"
      pattern: "import type.*Player|Effect"
    - from: "test/responseTables.test.ts"
      to: "src/types/tables.ts"
      via: "type imports for table entry types"
      pattern: "import type.*TableEntry"
---

<objective>
Migrate unit test files to TypeScript with full type coverage

Purpose: Convert the three pure function test files (utils, responseTables, selfcheck) from JavaScript to TypeScript, establishing the patterns for typed test fixtures that will be used in subsequent integration test migrations.

Output: Three `.test.ts` files with proper type imports, typed test fixtures, and no `any` types.
</objective>

<execution_context>
@/Users/daniel/.claude/get-shit-done/workflows/execute-plan.md
@/Users/daniel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-test-migration-validation/06-RESEARCH.md

@src/types/state.ts
@src/types/tables.ts
@test/utils.test.js
@test/responseTables.test.js
@test/selfcheck.test.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate utils.test.js to TypeScript</name>
  <files>test/utils.test.ts</files>
  <action>
1. Rename test/utils.test.js to test/utils.test.ts

2. Add type imports at top of file:
```typescript
import type { Player, Effect } from "../src/types/index.js";
```

3. Update import path to use .ts extension:
```typescript
import { clamp, clampInt, hasLiveEffect } from "../utils.ts";
```

4. Type the player fixtures in hasLiveEffect tests using Pick<Player, 'activeEffects'>:
```typescript
const player: Pick<Player, 'activeEffects'> = {
  activeEffects: [
    {
      id: "e1",
      type: "panic_paranoid",
      label: "Paranoid",
      severity: 3,
      createdAt: Date.now(),
      durationType: "manual",
      clearedAt: null,
    },
  ],
};
```

5. For tests that pass invalid types (NaN, "invalid", undefined), use type assertions:
```typescript
expect(clamp("invalid" as unknown as number, 0, 10)).toBe(0);
expect(clamp(undefined as unknown as number, 0, 10)).toBe(0);
```

6. Delete the original .js file after migration.

IMPORTANT: Do NOT change any test logic or assertions. Only add types.
  </action>
  <verify>npm run typecheck && npm test -- test/utils.test.ts</verify>
  <done>utils.test.ts compiles with strict mode, all 17 tests pass, no any types</done>
</task>

<task type="auto">
  <name>Task 2: Migrate responseTables.test.js to TypeScript</name>
  <files>test/responseTables.test.ts</files>
  <action>
1. Rename test/responseTables.test.js to test/responseTables.test.ts

2. Add type imports at top of file:
```typescript
import type { StressTableEntry, PanicTableEntry } from "../src/types/index.js";
```

3. Update import path:
```typescript
import {
  STRESS_TABLE,
  PANIC_TABLE,
  resolveEntry,
  getEntryById,
} from "../responseTables.ts";
```

4. Type the forEach callback parameters in table structure tests:
```typescript
STRESS_TABLE.forEach((entry: StressTableEntry) => {
  expect(entry).toHaveProperty("min");
  // ...
});

PANIC_TABLE.forEach((entry: PanicTableEntry) => {
  expect(entry).toHaveProperty("min");
  // ...
});
```

5. Type the entry variables in specific tests:
```typescript
const entry: StressTableEntry = resolveEntry("stress", 0);
```

6. For getEntryById tests with null/undefined, use type assertions as needed:
```typescript
const entry = getEntryById("stress", undefined as unknown as string);
const entry = getEntryById("stress", null as unknown as string);
```

7. Delete the original .js file after migration.

IMPORTANT: Do NOT change any test logic or assertions. Only add types.
  </action>
  <verify>npm run typecheck && npm test -- test/responseTables.test.ts</verify>
  <done>responseTables.test.ts compiles with strict mode, all 24 tests pass, no any types</done>
</task>

<task type="auto">
  <name>Task 3: Migrate selfcheck.test.js to TypeScript</name>
  <files>test/selfcheck.test.ts</files>
  <action>
1. Rename test/selfcheck.test.js to test/selfcheck.test.ts

2. Add type imports at top of file:
```typescript
import type { StressTableEntry, PanicTableEntry } from "../src/types/index.js";
```

3. Update import path:
```typescript
import {
  STRESS_TABLE,
  PANIC_TABLE,
  resolveEntry,
} from "../responseTables.ts";
```

4. Type the entry access in forEach loops:
```typescript
[...STRESS_TABLE, ...PANIC_TABLE].forEach((entry: StressTableEntry | PanicTableEntry) => {
  requiredFields.forEach((field) => {
    expect(entry).toHaveProperty(field);
    expect(entry[field as keyof typeof entry]).toBeDefined();
  });
});
```

5. Type the table array in the validation test:
```typescript
([STRESS_TABLE, PANIC_TABLE] as Array<StressTableEntry[] | PanicTableEntry[]>).forEach((table) => {
  table.forEach((entry) => {
    expect(entry.min).toBeLessThanOrEqual(entry.max);
  });
});
```

6. Delete the original .js file after migration.

IMPORTANT: Do NOT change any test logic or assertions. Only add types.
  </action>
  <verify>npm run typecheck && npm test -- test/selfcheck.test.ts</verify>
  <done>selfcheck.test.ts compiles with strict mode, all 5 tests pass, no any types</done>
</task>

</tasks>

<verification>
Run full test suite to verify no regressions:

```bash
# Type check all migrated files
npm run typecheck

# Run all unit tests (migrated)
npm test -- test/utils.test.ts test/responseTables.test.ts test/selfcheck.test.ts

# Verify test count unchanged (46 tests)
npm test -- test/utils.test.ts test/responseTables.test.ts test/selfcheck.test.ts 2>&1 | grep -E "Tests.*passed"
```
</verification>

<success_criteria>
- All three unit test files converted to TypeScript (.test.ts)
- Original .js test files deleted
- npm run typecheck passes with no errors
- All 46 unit tests pass (17 + 24 + 5)
- No `any` types in migrated test files
- Type imports from src/types/ used for fixtures
</success_criteria>

<output>
After completion, create `.planning/phases/06-test-migration-validation/06-01-SUMMARY.md`
</output>
